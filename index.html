<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>国际音标学习卡片</title>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=yM4ApGw0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #5a67d8;
            text-align: center;
        }
        .phonetic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        .phonetic-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .phonetic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background: #edf2f7;
        }
        .symbol {
            font-size: 28px;
            color: #2d3748;
            margin-bottom: 10px;
        }
        .example {
            font-size: 14px;
            color: #718096;
        }
        .category {
            margin-top: 30px;
        }
        .category-title {
            color: #4a5568;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        #practice-area {
            margin-top: 30px;
            padding: 20px;
            background: #f0fff4;
            border-radius: 10px;
            text-align: center;
        }
        button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #38a169;
        }
    </style>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=yM4ApGw0"></script>
</head>
<body>
    <div class="container">
        <h1>🎵 国际音标学习卡片 🎵</h1>
        <div style="text-align: center; margin-bottom: 20px; color: #718096;">
            <strong>总计44个音标</strong> = 12个单元音 + 8个双元音 + 24个辅音
        </div>
        
        <div class="category">
            <div class="category-title">单元音 (Monophthongs) - 12个</div>
            <div class="phonetic-grid" id="vowels"></div>
        </div>

        <div class="category">
            <div class="category-title">双元音 (Diphthongs) - 8个</div>
            <div class="phonetic-grid" id="diphthongs"></div>
        </div>

        <div class="category">
            <div class="category-title">辅音 (Consonants) - 24个</div>
            <div class="phonetic-grid" id="consonants"></div>
        </div>

        <div id="practice-area">
            <h2>练习区</h2>
            <div style="margin-bottom: 15px;">
                <button onclick="testResponsiveVoice()" style="background: #e53e3e;">测试语音</button>
                <button onclick="testBrowserTTS()" style="background: #3182ce;">测试浏览器TTS</button>
            </div>
            <div id="question" style="font-size: 48px; margin: 20px;">?</div>
            <button onclick="startPractice()">开始练习</button>
            <button onclick="checkAnswer()">显示答案</button>
            <div id="answer" style="margin-top: 20px; font-size: 18px;"></div>
        </div>
    </div>

    <script>
        // 词库和状态管理
        let wordsData = {};
        let cardClickCount = {};
        let currentSymbol = null;

        // 音标分类
        const vowels = ['iː', 'ɪ', 'e', 'æ', 'ɑː', 'ɒ', 'ɔː', 'ʊ', 'uː', 'ʌ', 'ɜː', 'ə'];
        const diphthongs = ['eɪ', 'aɪ', 'ɔɪ', 'aʊ', 'əʊ', 'ɪə', 'eə', 'ʊə'];
        const consonants = ['p', 'b', 't', 'd', 'k', 'g', 'tʃ', 'dʒ', 'f', 'v', 'θ', 'ð', 's', 'z', 'ʃ', 'ʒ', 'h', 'm', 'n', 'ŋ', 'l', 'r', 'w', 'j'];

        // 异步加载词库
        fetch('words.json')
            .then(response => response.json())
            .then(data => {
                wordsData = data;
                // 初始化点击计数
                Object.keys(wordsData).forEach(key => {
                    cardClickCount[key] = 0;
                });
                // 创建所有卡片
                createCards(vowels, 'vowels');
                createCards(diphthongs, 'diphthongs');
                createCards(consonants, 'consonants');
                console.log('词库加载成功，ResponsiveVoice状态:', typeof responsiveVoice);
            })
            .catch(error => {
                console.error('加载词库失败:', error);
                // 使用降级方案
                initializeFallback();
            });

        // 创建卡片函数
        function createCards(symbols, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            symbols.forEach(symbol => {
                const card = document.createElement('div');
                card.className = 'phonetic-card';
                
                // 获取当前显示的单词
                const currentWord = getCurrentWord(symbol);
                
                card.innerHTML = `
                    <div class="symbol">${symbol}</div>
                    <div class="example">${currentWord}</div>
                `;
                
                card.onclick = () => handleCardClick(symbol, symbols, containerId);
                container.appendChild(card);
            });
        }

        // 获取当前显示的单词
        function getCurrentWord(symbol) {
            if (!wordsData[symbol] || wordsData[symbol].length === 0) return symbol;
            const wordIndex = Math.floor(cardClickCount[symbol] / 3) % wordsData[symbol].length;
            return wordsData[symbol][wordIndex];
        }

        // 处理卡片点击
        function handleCardClick(symbol, symbols, containerId) {
            console.log('=== 点击音标 ===', symbol);
            
            // 增加点击计数
            cardClickCount[symbol]++;
            const currentWord = getCurrentWord(symbol);
            console.log('当前单词:', currentWord);
            console.log('ResponsiveVoice可用:', typeof responsiveVoice !== 'undefined');
            
            // 显示点击反馈
            alert(`点击了音标: ${symbol}\n当前单词: ${currentWord}\nResponsiveVoice状态: ${typeof responsiveVoice !== 'undefined' ? '可用' : '不可用'}`);
            
            // 发音：先读音标，再读单词
            if (typeof responsiveVoice !== 'undefined' && responsiveVoice.isPlaying) {
                responsiveVoice.cancel(); // 停止当前播放
            }
            
            if (typeof responsiveVoice !== 'undefined') {
                console.log('尝试播放音标:', symbol);
                try {
                    responsiveVoice.speak(symbol, "UK English Female", {
                        rate: 0.8,
                        onstart: function() {
                            console.log('开始播放音标:', symbol);
                        },
                        onend: function() {
                            console.log('音标播放完成，开始播放单词:', currentWord);
                            responsiveVoice.speak(currentWord, "UK English Female", {
                                rate: 0.8,
                                onstart: function() {
                                    console.log('开始播放单词:', currentWord);
                                },
                                onend: function() {
                                    console.log('单词播放完成');
                                }
                            });
                        },
                        onerror: function(error) {
                            console.error('播放音标出错:', error);
                            alert('播放音标出错: ' + error);
                        }
                    });
                } catch(error) {
                    console.error('ResponsiveVoice调用出错:', error);
                    alert('ResponsiveVoice调用出错: ' + error);
                    // 降级到浏览器TTS
                    speak(currentWord);
                }
            } else {
                console.error('ResponsiveVoice未加载，使用降级方案');
                alert('ResponsiveVoice未加载，使用浏览器TTS');
                // 降级到浏览器TTS
                speak(currentWord);
            }
            
            // 每点击3次切换单词
            if (cardClickCount[symbol] % 3 === 0) {
                setTimeout(() => {
                    createCards(symbols, containerId);
                }, 100);
            }
        }

        // 降级TTS函数
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.8;
            speechSynthesis.speak(utterance);
        }

        // 练习功能
        function startPractice() {
            if (Object.keys(wordsData).length === 0) {
                alert('词库还在加载中，请稍等...');
                return;
            }
            
            const allSymbols = [...vowels, ...diphthongs, ...consonants];
            currentSymbol = allSymbols[Math.floor(Math.random() * allSymbols.length)];
            const currentWord = getCurrentWord(currentSymbol);
            
            // 显示单词的音标形式
            document.getElementById('question').textContent = getWordPhonetics(currentWord);
            document.getElementById('answer').textContent = '';
        }

        function checkAnswer() {
            if (!currentSymbol) return;
            
            const currentWord = getCurrentWord(currentSymbol);
            document.getElementById('answer').textContent = `答案: ${currentWord}`;
            
            // 发音
            if (typeof responsiveVoice !== 'undefined') {
                responsiveVoice.speak(currentSymbol, "UK English Female", {
                    rate: 0.8,
                    onend: function() {
                        responsiveVoice.speak(currentWord, "UK English Female", {rate: 0.8});
                    }
                });
            } else {
                speak(currentWord);
            }
        }

        // 获取单词的音标形式（简化版）
        function getWordPhonetics(word) {
            const phoneticMap = {
                'like': 'laɪk', 'life': 'laɪf', 'time': 'taɪm',
                'day': 'deɪ', 'play': 'pleɪ', 'make': 'meɪk',
                'see': 'siː', 'need': 'niːd', 'keep': 'kiːp',
                'sit': 'sɪt', 'big': 'bɪɡ', 'fish': 'fɪʃ'
            };
            return phoneticMap[word] || word;
        }

        // 降级初始化
        function initializeFallback() {
            console.log('使用降级方案初始化');
            wordsData = {
                'aɪ': ['like', 'life', 'time'],
                'eɪ': ['day', 'play', 'make'],
                'iː': ['see', 'need', 'keep']
                // 添加更多...
            };
            Object.keys(wordsData).forEach(key => {
                cardClickCount[key] = 0;
            });
            createCards(['aɪ', 'eɪ', 'iː'], 'vowels');
        }

        // 测试函数
        function testResponsiveVoice() {
            console.log('=== 测试 ResponsiveVoice ===');
            console.log('ResponsiveVoice可用:', typeof responsiveVoice !== 'undefined');
            
            if (typeof responsiveVoice !== 'undefined') {
                console.log('ResponsiveVoice版本:', responsiveVoice.version || '未知');
                console.log('可用语音:', responsiveVoice.getVoices ? responsiveVoice.getVoices().length : '未知');
                
                try {
                    responsiveVoice.speak("Hello, this is a test", "UK English Female", {
                        rate: 0.8,
                        onstart: function() {
                            console.log('ResponsiveVoice 开始播放');
                            alert('ResponsiveVoice 开始播放');
                        },
                        onend: function() {
                            console.log('ResponsiveVoice 播放完成');
                            alert('ResponsiveVoice 播放完成');
                        },
                        onerror: function(error) {
                            console.error('ResponsiveVoice 播放错误:', error);
                            alert('ResponsiveVoice 播放错误: ' + error);
                        }
                    });
                } catch(error) {
                    console.error('ResponsiveVoice 调用异常:', error);
                    alert('ResponsiveVoice 调用异常: ' + error);
                }
            } else {
                alert('ResponsiveVoice 未加载！');
            }
        }

        function testBrowserTTS() {
            console.log('=== 测试浏览器 TTS ===');
            try {
                const utterance = new SpeechSynthesisUtterance("Hello, this is browser TTS test");
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.onstart = function() {
                    console.log('浏览器TTS 开始播放');
                    alert('浏览器TTS 开始播放');
                };
                utterance.onend = function() {
                    console.log('浏览器TTS 播放完成');
                    alert('浏览器TTS 播放完成');
                };
                utterance.onerror = function(error) {
                    console.error('浏览器TTS 播放错误:', error);
                    alert('浏览器TTS 播放错误: ' + error);
                };
                speechSynthesis.speak(utterance);
            } catch(error) {
                console.error('浏览器TTS 调用异常:', error);
                alert('浏览器TTS 调用异常: ' + error);
            }
        }

        // 等待ResponsiveVoice加载
        function waitForResponsiveVoice() {
            if (typeof responsiveVoice !== 'undefined') {
                console.log('ResponsiveVoice已加载');
            } else {
                setTimeout(waitForResponsiveVoice, 100);
            }
        }
        waitForResponsiveVoice();
    </script>
</body>
</html>